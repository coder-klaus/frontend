进程底层会为每个打开的外部资源分配一个唯一标识

这个标识被称之为 文件描述符（file descriptor，简称fd）

+ 在 Linux 和 Mac中， 这个文件描述符是 一个整数数值
+ 在 Windows中，这个文件描述符 是 一个 对象结构值，也叫文件句柄 「 FileHandle 」



## 非promise调用

```js
import fs from 'node:fs';

fs.open('./data.txt', (err, fd) => {
  // 非 promise 调用 获取的文件描述符是一个整数
  console.log(fd) // 13

  // 文件描述符是比较底层的API，不会自动关闭，需要手动关闭
  // 手动关闭文件是好习惯，虽然进程结束时文件会自动关闭，但手动关闭更安全
  // 此外Node.js服务器进程通常一直运行（为客户端提供服务），如果打开的文件不关闭，会占用资源
  fs.close(fd, (err) => {
    if (err) console.log('关闭失败', err);
  });
});
```

```js
import fs from 'node:fs';

fs.open('./data.txt', (err, fd) => {
  // 获取到文件描述符后就可以执行任何操作

  // 读取文件和写入文件的第一个参数除了可以是路径，也可以是文件描述符
  fs.readFile(fd, (err, data) => {
    console.log(data.toString()) // Hello World

    // 非 promise 调用时 如果要获取文件元数据 则必须调用 fstat 方法
    // fstat 方法的第一个参数是必须数值型文件描述符
    fs.fstat(fd, (err, stats) => {
      // 返回 包含了文件元信息的对象 「 FileStat对象 」
      console.log(stats)

      // 用完后需手动关闭 => close是同步方法
      // 这里必须使用嵌套回调，因为回调函数是异步的，只有嵌套回调才能保证在读取完文件内容和获取完文件元数据后才关闭文件
      fs.close(fd)
    })
  })
});
```



## promise 调用

```js
// 除了可以使用默认导出的fs对象，fs上的方法也都进行了具名导出
import { open, readFile } from 'node:fs/promises';

// 使用 open 方法打开文件
const fd = await open('./data.txt')

// promise 调用时 如果的文件描述符是一个对象结构数据，被叫做文件句柄 「 FileHandle 」
console.log(fd)

// 同样获取文件描述符后，可以对文件进行任何操作
const data = await readFile(fd, 'utf-8')
console.log(data) // Hello World

// fd 是一个对象，其上有很多方法，例如 stat 方法，可以获取文件元数据
// 注意: 文件句柄上叫 stat 方法，文件描述符上叫 fstat 方法
console.log(await fd.stat())

// 使用 close 方法关闭文件 => 文件句柄的close方法是异步方法
await fd.close()
```



不过我们一般并不会直接使用文件描述符，因为文件描述符是比较底层的操作

Node 任何文件操作底层都依赖于这个文件描述符进行了二次封装，使用起来更高效和方便

```js
import fs from 'node:fs'

// 通过stat方法获取文件元数据 「 非promise版本 」=> 直接使用stat方法，不是fstat方法
// 和 readFile 和 writeFile 不同的是，stat方法的第一个参数只能是路径
fs.stat('./data.txt', (err, stats) => {
  if (err) {
    console.error(err)
  }
  console.log(stats)
})

// promise 版本
console.log(await fs.promises.stat('./data.txt'))
```

