## 解析请求体

### 手动解析

```js
import express from 'express'
import qs from 'qs'

const app = express()

// 通用中间件可以抽取公共逻辑，例如手动解析请求体
app.use((req, res, next) => {
  if (['application/json', 'application/x-www-form-urlencoded'].includes(req.headers['content-type'])) {
    let body = ''

    req.on('data', (chunk) => {
      body += chunk
    })

    req.on('end', () => {
      if (req.headers['content-type'] === 'application/json') {
        req.body = JSON.parse(body)
      } else if (req.headers['content-type'] === 'application/x-www-form-urlencoded') {
        // qs 是一个第三方库，用于解析 application/x-www-form-urlencoded 格式的请求体
        // 1. qs.parse 方法可以将请求体字符串转换为对象
        // 2. qs.stringify 方法可以将对象转换为请求体字符串
        // 注意: 使用 qs.parse 方法解析出的请求体对象中，值类型都是字符串类型值
        // 例如: { name: '张三', age: '18' } => 这里的 age的值是 '18'，不是 数字 18
        req.body = qs.parse(body)
      }

      next()
    })
  } else {
    next()
  }
})

app.post('/', (req, res) => {
  console.log(req.body)
  res.send('ok')
})

app.listen(3000)
```



### 使用内置中间件

不过这种常用功能，`Express`已经内置默认集成

```js
import express from 'express'

const app = express()

// Express 内置中间件，用于解析 application/json 格式的请求体
app.use(express.json())
// Express 内置中间件，用于解析 application/x-www-form-urlencoded 格式的请求体
app.use(express.urlencoded())

// 假设请求体为 { name: '张三', age: 18 }
app.post('/json', (req, res) => {
  // JSON格式数据可以解析出非字符串数据类型
  console.log(req.body) // { name: '张三', age: 18 }
  res.send('json格式解析成功')
})

// 假设请求体为 name=张三&age=18
app.post('/urlencoded', (req, res) => {
  // 注意: urlencoded 格式解析出来的数据是字符串
  // 因为 Express 底层在解析时 使用的第三方库 也是 qs
  console.log(req.body) // { name: '张三', age: '18' }
  res.send('urlencoded格式解析成功')
})

app.listen(3000)
```



> 早期解析 urlencode 格式请求体的方式是
>
> ```js
> app.use(express.urlencoded({ extended: true }));
> ```
>
> 因为早期Express默认使用`querystring`库进行解析，但这个库已经不再维护
>
> 使用`{ extended: true }` 表示使用最新的`qs`库进行解析
>
> 但目前已经不需要`{ extended: true }`了，默认直接使用`qs`库进行解析



## 解析query

```js
import express from 'express'

const app = express()

// 请求url => http://localhost:3000?name=张三&age=18
app.get('/', (req, res) => {
  // 解析出的结果值都是字符串类型值 => 例如这里的age是字符串'18', 不是数字18
  console.log(req.query) // { name: '张三', age: '18' }
  res.send('hello world')
})

app.listen(3000)
```



## 解析params

```js
import express from 'express'

const app = express()

// 请求url => http://localhost:3000/张三/18
// 可以同时设置多个params参数
app.get('/:name/:age', (req, res) => {
  // 解析出的结果值都是字符串类型值 => 例如这里的age是字符串'18', 不是数字18
  console.log(req.params) // { name: '张三', age: '18' }
  res.send('hello world')
})

app.listen(3000)
```



### 类型校对

```js
// 老版本的Express支持路由正则，新版的Express因为使用底层库问题，暂不支持路由正则 => Express V5.1.0
app.get('/:id(\\d+)', (req, res) => {
  console.log(req.params) 
  res.send('hello world')
})
```

只能手动进行解析

```js
import express from 'express'

const app = express()

// 请求url => http://localhost:3000/10086
app.get('/:id', (req, res) => {
  if (!/^\d+$/.test(req.params.id)) {
    // 1. 通过 status 方法 设置 响应码
    // 2. 通过 send 方法 设置 响应体 「 Content-Type的值为 text/html; charset=utf-8 」
    res.status(400).send('id 必须是数字')
  }
  res.send('hello world')
})

app.listen(3000)
```



