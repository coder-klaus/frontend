Koa 和 Express 都由同一个团队开发。

与 Express 默认集成大量常用中间件不同，Koa 只保留了最核心的功能，其他中间件需要单独安装。

你可以选择官方、第三方，甚至自己编写的中间件，因此 Koa 灵活性更高、可定制性更强。

另外，Koa 的中间件机制采用“洋葱模型”，对异步操作的支持也比 Express 更加完善。



## 初体验

```js
import Koa from 'koa';

// 和 Express不一样，Koa是一个类，需要通过 new 来创建实例
const app = new Koa();

// 使用 use 方法来注册中间件
app.use(async (ctx) => {
  ctx.body = 'Hello World';
});

// 使用 listen 方法来启动服务器
app.listen(3000, () => {
  console.log('Server is running on port 3000');
});
```



## 中间件

Koa 的中间件函数有两个参数：`ctx`（上下文对象）和 `next`（下一个中间件函数）。

这与 Express 不同，Express 的中间件接收 `req`、`res` 和 `next` 三个参数。



`ctx` 包含了请求和响应的所有常用属性，常见信息都可以直接通过 `ctx` 获取。

`next` 用于调用下一个中间件，和 Express 不同，Koa 的 `next` 总是无参，并且返回一个 Promise，因此可以结合 async/await 使用。



`获取请求和响应对象`

```js
app.use(async (ctx, next) => {
  // Koa 底层也是基于 http的 createServer 来创建服务
  // ctx.req 和 ctx.res 是原生的 Node.js 请求和响应对象
  console.log(ctx.req, ctx.res)

  // ctx.request 和 ctx.response 是 Koa 基于 req 和 res 二次封装扩展后的请求和响应对象
  // 例如 res存在end方法，而 response禁用了end方法，让我们通过ctx.body，即ctx.response.body来响应结果
  console.log(ctx.request, ctx.response)

  // 使用 ctx.body 来设置响应内容 => 会自动设置 Content-Type 为 text/plain
  ctx.body = 'Hello World';
});
```



`通过 ctx 获取常见请求信息`

```js
// 请求路径为 http://localhost:3000/Klaus?key=3&q=hello
app.use(async (ctx, next) => {
  // 大部分在 ctx.request 和 ctx.response 中的属性和方法都可以直接通过 ctx 来访问
  console.log(ctx.url) // 获取请求路径 => /Klaus?key=3&q=hello
  console.log(ctx.path) // 获取请求路径 => /Klaus
  console.log(ctx.method) // 获取请求方法 => GET
  console.log(ctx.protocol) // 获取请求协议 => http
  console.log(ctx.query) // 获取请求参数「 默认值 {} 」 => { key: '3', q: 'hello' }

  ctx.body = 'Hello World';
});
```



`Koa 原生 ctx.params 行为说明`

```js
app.use(async (ctx, next) => {
  // Koa 默认只支持通用匹配中间件，不支持 路径中间件 和 方法中间件
  // 同时也不支持 动态路由，所以默认情况下，ctx.params 为 undefined
  // 如果要支持，则需要安装 @koa/router 库，其本质是基于 Koa 的中间件，用于处理路由
  console.log(ctx.params) // undefined

  ctx.body = 'Hello World';
});
```



`设置响应头、Cookie 和状态码`

```js
app.use(async (ctx, next) => {
  // 设置响应头
  ctx.set('x-extra-token', 'sadasdasdasetwewfa');

  // 如果设置的响应头是 Content-Type，则可以使用 ctx.type 这个语法糖写法
  ctx.type = 'text/html; charset=utf-8';

  // 设置 cookie
  ctx.cookies.set('name', 'Klaus', {
    httpOnly: true,
    maxAge: 1000 * 60 * 60 * 24 * 30,
    path: '/',
  });

  // 获取 cookie
  console.log(ctx.cookies.get('name'))

  // 设置响应状态码
  // 1. 设置响应码后，会自动设置对应响应描述信息
  // 2. 一般不需要设置，Koa会自动根据响应的内容自动设置
  ctx.status = 201;
  // 设置响应体
  ctx.body = 'Hello World';
});
```



`中间件的链式调用`

```js
// 默认情况下，Koa 不支持一次注册多个中间件
app.use(() => console.log(1));
```

```js
// 中间件默认返回 app 对象，所以可以链式调用
// 中间件也是需要通过 next 来调用下一个中间件
app.use((ctx, next) => {
  console.log(1)
  next()
}).use((ctx, next) => {
  console.log(2)
  next()
}).use((ctx, next) => {
  console.log(3)
  next()
});
```

