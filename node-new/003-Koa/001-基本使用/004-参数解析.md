## query参数

`Koa`自带，无需安装中间件

假设请求路径为 => `http://localhost:3000?name=Klaus&age=23`

```js
import Koa from 'koa'
import Router from '@koa/router'

const router = new Router()

router.get('/', (ctx, next) => {
  // 会自动解析为对象
  console.log(ctx.query) // { name: 'Klaus', age: '23' }
  ctx.body = `Hello ${ctx.query.name}`
})

const app = new Koa()
app.use(router.routes()).use(router.allowedMethods())

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})

```



## 动态路由参数

`Koa`自带，无需安装中间件

假设请求路径为 => `http://localhost:3000/10086`



### 基本使用

```js
import Koa from 'koa'
import Router from '@koa/router'

const router = new Router()

// 使用路由插件后，就可以使用 ctx.params 获取路由参数
router.get('/:id', (ctx, next) => {
  ctx.body = `Hello ${ctx.params.id}`
})

const app = new Koa()
app.use(router.routes()).use(router.allowedMethods())

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



### 参数正则

```js
import Koa from 'koa'
import Router from '@koa/router'

const router = new Router()

// 路由参数可以用正则限制动态参数类型
// 这里正则写在字符串里，所以要用 \\ 表示 \
// 如果写成 \d+，JS 解析时会把 \d 当作转义字符，但 \d 不是有效转义，实际交给正则解析引擎的正则变成 d+，正则解析为一个或多个字母d
// 用 \\d+，JS 解析成 \d+，然后交给正则解析引擎解析，此时正则才能生效
router.get('/:id(\\d+)', (ctx, next) => {
  ctx.body = `Hello ${ctx.params.id}`
})

const app = new Koa()
app.use(router.routes()).use(router.allowedMethods())

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



### 多个动态参数

假设请求路径为 => `http://localhost:3000/klaus/23`

```js
import Koa from 'koa'
import Router from '@koa/router'

const router = new Router()

router.get('/:name/:age', (ctx, next) => {
  // 会自动转换为对象
  console.log(ctx.params) // { name: 'klaus', age: '23' }
  ctx.body = `Hello ${ctx.params.name}`
})

const app = new Koa()
app.use(router.routes()).use(router.allowedMethods())

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



## 获取请求体 => json格式

`koa`默认不支持，需要安装插件`@koa/bodyparser`

> `koa-bodyparser`是老版本，已经不再维护
>
> 目前推荐使用的是`@koa/bodyparser`



假设请求路径为 => `http://localhost:3000/`

假设请求体为 

```json
{
  "username": "admin",
  "password": "1234516"
}
```

代码如下:

```js
import Koa from 'koa'
import Router from '@koa/router'
import bodyParser from '@koa/bodyparser'

const router = new Router()

router.post('/', (ctx, next) => {
  // 解析后的请求体会被挂载到 ctx.request.body 上
  // 注意: ctx.body 已经表示响应体了，所以要使用请求体只能通过 ctx.request.body
  console.log(ctx.request.body) // { username: 'admin', password: '1234516' }
  ctx.body = `Hello ${JSON.stringify(ctx.request.body)}`
})

const app = new Koa()

// 使用 bodyParser 解析请求体
// 这个中间件要放在 实际的路由注册 之前，不然也就没有使用的意义了
app.use(bodyParser())
app.use(router.routes()).use(router.allowedMethods())

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



## 获取请求体 => urlencode格式

`koa`默认不支持，需要安装插件`@koa/bodyparser`

假设请求路径为 => `http://localhost:3000/`

假设请求体为 `username=admin&password=1234516`

```js
import Koa from 'koa'
import Router from '@koa/router'
import bodyParser from '@koa/bodyparser'

const router = new Router()

router.post('/', (ctx, next) => {
  // 同样的，urlencode 格式请求体也会被解析为对象类型值
  console.log(ctx.request.body) // { name: 'Klaus', age: '123516' }
  ctx.body = `Hello ${JSON.stringify(ctx.request.body)}`
})

const app = new Koa()

app.use(bodyParser())
app.use(router.routes()).use(router.allowedMethods())

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



## 获取请求体 => 表单格式

`koa`默认不支持，需要安装`@koa/multer`

`@koa/multer` 实际上是基于 `multer` 封装的，专门为 `koa` 提供更为便捷的使用方式

> 同样存在不维护的老库 `koa-multer`,  推荐使用正在维护的新库 `@koa/multer`

```js
pnpm add multer @koa/multer
```



使用如下

```js
import Koa from 'koa'
import Router from '@koa/router'
import multer from '@koa/multer'

const router = new Router()

// 1. 表单处理可能只是某几个接口需要使用的功能，所以只要扩展这几个接口即可，不需要设置为全局中间件
// 2. @koa/multer 底层基于 multer，所以使用方式和 multer 一致
//    @koa/multer 唯一执行的扩展是将结果挂载到 ctx 上
router.post('/form', multer().none(), (ctx, next) => {
  // 1. 会自动转对象
  // 2. multer.none() 表示表单只能有普通字段，不能存在文件字段 => 如果存在文件字段则直接报错
  // 3. multer.any() 表示表单可以有普通字段，也可以有文件字段
  // 4. 如果是文件上传，单个文件对应元信息会存放在 ctx.file 上
  //    多个文件元信息会以数组或对象的形式存放在 ctx.files 上，而普通字段存放在 ctx.request.body 上
  console.log(ctx.request.body) // 解析结果类似于 { name: 'Klaus', age: '23' }
  ctx.body = 'ok'
})

const app = new Koa()

app.use(router.routes()).use(router.allowedMethods())

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```

