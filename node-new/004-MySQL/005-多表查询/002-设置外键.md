假设已经存在如下表结构

```sql
-- 创建一个简单的订单表
CREATE TABLE IF NOT EXISTS orders (
    id INT PRIMARY KEY,                   -- 订单ID，主键
    customer_name VARCHAR(50),            -- 客户姓名（冗余字段）
    product VARCHAR(50),                  -- 产品名称
    amount DECIMAL(10,2)                  -- 订单金额
);

-- 插入测试数据
INSERT INTO orders (id, customer_name, product, amount) VALUES
(1, '张三', '手机', 2999.00),
(2, '李四', '电脑', 5999.00),
(3, '张三', '平板', 1999.00);

SELECT * FROM orders;
```

查询结果如下

![image.png](https://s2.loli.net/2025/06/29/iz9SRE7Gdvcjwfx.png) 

在查询结果中，“张三”出现了多次，产生了数据冗余

这里只是示例，实际存储可能会浪费很多资源，因此我们需要对其进行数据拆分



第一步，将冗余数据单独抽离形成一张新表`customers`

```sql
-- 创建客户信息表
CREATE TABLE IF NOT EXISTS customers (
    id INT PRIMARY KEY,             -- 客户ID，主键
    customer_name VARCHAR(50)       -- 客户姓名
);

-- 插入测试数据
INSERT INTO customers (id, customer_name) VALUES
(1, '张三'),
(2, '李四');

SELECT * FROM customers;
```

![image.png](https://s2.loli.net/2025/06/29/dZP6MRqJSm9beBs.png) 



第二步，在`orders`表中新增字段`customer_id` 作为外键，关联`customers`的`id`

```sql
-- 新增外键字段 customer_id
ALTER TABLE orders ADD customer_id INT;

-- 添加外键约束，orders.customer_id 引用 customers.id
-- + FOREIGN KEY 后字段需用括号 => FOREIGN KEY (customer_id) 合法，FOREIGN KEY customer_id 不合法
-- + 设置外键的表为从表，被引用的表为主表 => 这类 customers是主表，orders是从表
-- + 只有存在唯一约束字段才可以作为另一个表的外键
-- + 从表中外键字段值必须是主表中对应被引用字段值中的一个 => 外键约束
-- 	 + 外键字段可为 NULL，但非 NULL 时必须为主表中对应字段的值
-- + 主表被引用字段对应值在被引用时不能随意删除或更新 => 外键参照约束
ALTER TABLE orders ADD FOREIGN KEY (customer_id) REFERENCES customers(id);

-- 查看建表语句
SHOW CREATE TABLE orders;
/*
CREATE TABLE `orders` (
  `id` int NOT NULL,
  `customer_name` varchar(50) DEFAULT NULL,
  `product` varchar(50) DEFAULT NULL,
  `amount` decimal(10,2) DEFAULT NULL,
  `customer_id` int DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `customer_id` (`customer_id`),
  -- customer_id 是字段名，不是外键约束名, 外键约束名为 orders_ibfk_1，由系统自动生成
  CONSTRAINT `orders_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
*/
```



第三步，更新从表数据

```sql
UPDATE orders SET customer_id = 1 WHERE customer_name = '张三';
UPDATE orders SET customer_id = 2 WHERE customer_name = '李四';
```





第四步，移除冗余字段

> 确保在删除冗余字段之前，所有数据都已正确迁移并验证无误

```sql
ALTER TABLE orders DROP customer_name;
```





我们也可以在新建表的时候就已经设置好对应的外键

```sql
CREATE TABLE t_song (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(20) NOT NULL,
    duration INT,
    singer_id INT,
    -- 设置外键
    FOREIGN KEY (singer_id) REFERENCES t_singer(id)
);
```



## 联合外键

有的时候，主表的主键是联合主键

```sql
CREATE TABLE products (
    product_code VARCHAR(20),
    version INT,
    name VARCHAR(50),
    PRIMARY KEY (product_code, version)
);
```

此时创建的外键就需要时联合外键

```sql
CREATE TABLE order_items (
    order_id INT,
    product_code VARCHAR(20),
    version INT,
    quantity INT,
    -- 联合外键，引用 products(product_code, version)
    FOREIGN KEY (product_code, version) REFERENCES products(product_code, version)
);
```

