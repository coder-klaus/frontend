## 锁文件

npm 的锁文件是 `package-lock.json`，通常在安装依赖时自动生成，大多数情况下无需手动修改。

1. **固定版本**：

   + `package.json` 只指定了依赖的版本范围（如 `^1.2.3` 或 `~1.2.3`），实际安装时每个人获取到的具体版本可能不同。
   + 如果只锁定大版本，团队成员间可能因为依赖版本不一致导致功能异常。「 库的小版本可能提供了新功能 」
   + 锁文件会记录每个依赖的具体版本号，确保所有开发者和环境中安装的依赖完全一致。
   + 升级依赖时，只需删除锁文件并重新安装，系统会根据最新依赖重新生成锁文件。

2. **记录依赖关系**：

   + 锁文件会完整记录每个依赖及其子依赖的具体版本和依赖关系，便于还原和追溯。

3. **优化缓存**：

   + 项目中多个依赖可能引用同一个库的同一版本，锁文件避免了重复下载和安装。
   + 安装依赖时，npm 会为每个包生成唯一的 hash 标识（基于 SHA-512），并在本地 `.npm` 缓存中查找是否已下载过。
     + SHA-512是hash算法，也就是无论生成多少次，对应的值都是一致不变的
   + 如有缓存，直接解压到 `node_modules`，无须重新下载；否则从 npm 仓库下载 `.tgz` 压缩包，解压到`node_modules`并更新缓存。



**不同包管理器的锁文件名称**

- npm：`package-lock.json`
- yarn：`yarn.lock`
- pnpm：`pnpm-lock.yaml`

   

### tgz

`.tgz` 是类 Unix 系统中常见的一种压缩归档文件格式

`.tgz` 文件其实是 `.tar.gz` 文件的简写。

含义：

- `.tar`：Tape Archive（打包归档，不压缩）
- `.gz`：GNU zip（gzip压缩）

过程：

1. 先用 `tar` 命令将多个文件/文件夹打包成一个 `.tar` 文件。
2. 再用 `gzip` 对 `.tar` 文件进行压缩，生成 `.tar.gz` 文件。
3. 由于 `.tar.gz` 文件名较长，常简写为 `.tgz`。



### tar

- 在 Unix/Linux 系统中，一切皆文件，目录本质上也是一种特殊的文件
- **tar** 可以把你指定的“文件”（包括普通文件、目录文件）都**打包成一个归档文件**。
- tar可以简单理解为是某一文件或目录的临时快照备份，其本身只备份但不压缩



## npm install 流程

![image.png](https://s2.loli.net/2025/07/07/EoaSkpGchZC12Wb.png)  

当 `npm install`时

1. npm 首先会检查当前目录下是否存在锁文件
2. 存在锁文件时
   + 查看有没有满足条件的最新包
   + 如果有则重新下载，缓存并更新锁文件
   + 没有则直接使用缓存，解压到`node_modules`中，替换对应目录
3. 不存在锁文件时
   + npm 会根据 `package.json` 中声明的依赖，解析所有直接和间接依赖，生成完整的依赖关系树
   + 对于每个依赖，npm 会选择**满足 semver 版本范围的最新版本**进行安装。
   + 下载的依赖会被缓存到本地，并解压到 `node_modules` 目录。
   + 安装完成后，npm 会自动生成新的锁文件（`package-lock.json`），记录本次安装的所有依赖及其具体版本。

