Express 提供的功能主要依赖于 后端路由 和 其对应的中间件

所谓中间件就是 Express中用于处理请求和响应的一系列函数

简单来说 无论是 app.get、app.post 还是 app.use 注册的回调函数，都是中间件



## 中间件处理函数

每个中间件处理函数都接收三个参数

1. `req`  => 基于 `Node` `http`模块的 `request` 对象 进行二次封装的对象
2. `res`  => 基于 `Node` `http`模块的 `response` 对象 进行二次封装的对象
3. `next` => 控制是否执行下一个中间件

```js
import express from 'express'

const app = express()

// app.get的第二个参数就是中间件
app.get('/', (req, res) => {
  res.send('Hello World')
})

// 启动服务器，监听 3000 端口
app.listen(3000)
```



### req 的常见属性

```js
import express from 'express'

const app = express()

// 请求地址 => http://localhost:3000/klaus?pid=2
app.use((req, res, next) => {
  console.log(req.url) // => /klaus?pid=2
  console.log(req.path) // => /klaus
  console.log(req.method) // => GET
  console.log(req.protocol) // => http
  console.log(req.query) // => { pid: '2' }
  console.log(req.params) // => {}
  res.send('hello world')
})

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



## 一次注册多个

每种中间件都可以一次注册多个中间件处理函数，他们会依次被回调

```js
import express from 'express'

const app = express()

// 任何中间件都可以一次注册多个中间件处理函数 => app.use(...middlewares)
/*
  最终执行结果
  1. 中间件1
  2. 中间件2
  3. 中间件3
  4. 响应结果
*/
app.use(
  (req, res, next) => { console.log('中间件1'); next() },
  (req, res, next) => { console.log('中间件2'); next() },
  (req, res, next) => { console.log('中间件3'); res.send('Hello World') }
)

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



## 链式调用

```js
import express from 'express'

const app = express()

// 每种中间件函数的返回值都是 app 对象, 所以可以链式调用
app.use((req, res, next) => { console.log('中间件1'); next() })
  .use((req, res, next) => { console.log('中间件1'); next() })
  .use((req, res, next) => { console.log('中间件1'); res.send('Hello World') })

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



## 基本执行流程

中间件的匹配规则是

1. Express 从上到下匹配，找到第一个符合条件的中间件执行。
2. 如果中间件结束请求（res.json 或 res.end），就停止
3. 如果调用 next()，继续执行下一个中间件。

```js
import express from 'express'

const app = express()

// 对于每一次请求, 符合条件的中间件都会被依次执行
// 在这个过程中，他们的 req 和 res 是 同一个 请求体 和 响应体
app.use((req, res, next) => {
   req.msg = 'a'
   next()
 })

// 在中间件中，要么通过next方法将处理控制权转移给下一个中间件
// 要么在当前中间件中做出响应，结束当前请求流程
// 否则，请求会卡在这里，直到超时 => 在客户端的表现就是 页面一直在转圈，处于加载中的状态
app.use((req, res, next) => {
  req.msg += 'b'
  next()
})

// 只有之前的中间件调用了next方法才会执行后续中间件
// 如果之前的中间件调用了 res.end() 或 res.json() 结束请求，那么后续中间件即使满足条件了也不会再执行了
app.use((req, res, next) => {
  req.msg += 'c'
  res.send(req.msg) // 响应结果 'abc
})

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



## 分类

在 Express 和 Koa 中，中间件可以分为以下三类：

1. **通用中间件**：不区分路径和请求方法，对所有请求生效。
2. **路径中间件**：只根据路径判断是否生效，但不区分请求方法。
3. **路由中间件**：同时根据路径和请求方法判断，仅在特定路径和请求方法下生效。

> 在实际业务开发中，**路由中间件**通常使用得最多，主要用于处理与路由相关的逻辑。
>
> 而**通用中间件**则一般用于功能扩展，比如日志记录、权限校验、错误处理等。或者用来抽取多个中间件拥有的执行逻辑



### 通用中间件

```js
import express from 'express'

const app = express()

app.use((req, res, next) => {
  res.send('app.use(callback) 是通用中间件')
})

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



### 路径中间件

```js
import express from 'express'

const app = express()

app.use('/home', (req, res, next) => {
  res.send('app.use(path,callback) 是路径中间件')
})

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



### 路由中间件

```js
import express from 'express'

const app = express()

app.get('/home', (req, res, next) => {
  res.send('app.<method>(path,callback) 是路由中间件')
})

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```



## 匹配失败

默认情况下，如果访问非法路由和使用不支持的方法请求路由时，Express会自动识别并都返回 `404 Not Found`

![image-20250703132934036](https://s2.loli.net/2025/07/03/R6YxTXthybOZaWI.png) 



