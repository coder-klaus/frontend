## 动态路由参数

```js
import Koa from 'koa'
import Router from '@koa/router'

const app = new Koa()
// 不传路由前缀，默认就是根路由 /
const router = new Router()

// 请求路径为 /Klaus/20
router.get('/:name/:age', (ctx) => {
  // 属性值都是字符串类型值
  console.log(ctx.params) // { name: 'Klaus', age: '20' }
  ctx.body = `Hello ${ctx.params.name}, you are ${ctx.params.age} years old`
})

app.use(router.routes()).use(router.allowedMethods())

app.listen(3000)
```



## 查询字符串

```js
import Koa from 'koa'
import Router from '@koa/router'

const app = new Koa()
// 不传路由前缀，默认就是根路由 /
const router = new Router()

// 请求路径为 /user?name=Tom&age=23
router.get('/user', (ctx) => {
  console.log(ctx.query) // { name: 'Tom', age: '23' }
  ctx.body = `Hello ${ctx.query.name}, you are ${ctx.query.age} years old`
})

app.use(router.routes()).use(router.allowedMethods())

app.listen(3000)
```



## JSON格式和urlencode参数

```js
import Koa from 'koa'
import Router from '@koa/router'
import bodyParser from 'koa-bodyparser'

const app = new Koa()

// 挂载bodyParser中间件
// 1. 可以自动解析请求体中的JSON对象和urlencoded数据
// 2. 将结果挂载到 ctx.request.body 上
app.use(bodyParser())

const router = new Router({ prefix: '/user' })

// 传入的 json数据为 {"name": "Tom", "age": 30}
router.post('/json', (ctx) => {
  console.log(ctx.request.body) // { name: 'Tom', age: 30 }
  ctx.body = ctx.request.body
})

// 传入的 urlencoded数据为 name=Tom&age=30
router.post('/urlencoded', (ctx) => {
  // 会自动转对象，但属性值为字符串 => url是字符串值，无法确定你要的是数字还是值以为数值的字符串
  console.log(ctx.request.body) // { name: 'Tom', age: '30' }
  ctx.body = ctx.request.body
})

app.use(router.routes()).use(router.allowedMethods())

app.listen(3000)
```



## POST请求的FormData格式

解析 `FormData` 格式数据需要通过 `multer`

`Koa`基于`multer`进行了二次封装，提供了中间件`@koa/multer`

`@koa/multer`会自动将将表单数据解析出来并自动挂载到`ctx.request.body`中

> 和`koa-router`一样，早期叫`koa-multer`，已经停止维护，推荐用@koa/multer。

```shell
pnpm install @koa/multer multer
```



```js
import Koa from 'koa'
import Router from '@koa/router'

// 本质基于 multer 实现，使用方式和 multer 一样
import multer from '@koa/multer'

const app = new Koa()
const router = new Router({ prefix: '/user' })

// 表单数据并不是所有接口都需要解析的，所以一般作用于单个接口
// 和 express 一样，路径中间件的类型为 router.<method>(path, ...middlewares)
// 对应中间件会被加入数组中，并被依次执行
router.post('/form', multer().any(), (ctx) => {
  console.log(ctx.request.body)
  ctx.body = ctx.request.body
})

app.use(router.routes()).use(router.allowedMethods())

app.listen(3000)
```



### 文件上传

```js
import Koa from 'koa'
import Router from '@koa/router'
import path from 'node:path'
// 底层基于 multer 实现，使用方式和 multer 一样
// 可以用于解析表单数据，也可以用于解析文件上传
import multer from '@koa/multer'

const app = new Koa()
const router = new Router({ prefix: '/user' })

const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, 'uploads')
  },
  filename: function (req, file, cb) {
    cb(null, file.fieldname + '-' + Date.now() + path.extname(file.originalname))
  }
})

const upload = multer({ storage: storage })

router.post('/upload', upload.single('avatar'), (ctx) => {
  // 凡是 ctx.request 和 ctx.response 上存在的属性 都可以通过 ctx 进行访问
  // 包括 multer 解析后挂载的文件信息 => 这是 @koa/multer 额外进行实现的
  // 单个文件信息挂载到 ctx.file 上，多个文件信息挂载到 ctx.files 上
  // 但有一个特别的: ctx.body 是 ctx.response.body
  // 而请求体的body 只能通过ctx.request.body 来获取
  console.log(ctx.file)
  ctx.body = '上传成功'
})

app.use(router.routes()).use(router.allowedMethods())

app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```

