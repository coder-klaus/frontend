## 主入口

`main.js`

```js
import Koa from 'koa'
import bodyParser from 'koa-bodyparser'

// CJS 导入时，可以省略后缀名。但 ESM 导入时，不能省略后缀名
import router from './router.js'
import errorHandler from './errorHandler.js'

const app = new Koa()

// 解析 JSON 和 urlencoded 请求体 并挂载到 ctx.request.body 上
// 默认 ctx.request.body 为 undefined
app.use(bodyParser())
app.use(router.routes()).use(router.allowedMethods())

errorHandler(app)

app.listen(3000)

export default app
```



## 路由文件

`router.js`

```js
import Router from '@koa/router'

const router = new Router()

router.post('/login',ctx => {
  const {username, password} = ctx.request.body
  console.log(username, password)
  if(username === 'admin' && password === '123456') {
    ctx.body = {
      code: 0,
      message: '登录成功'
    }
  } else {
    // ctx 上存在属性 app，本质就是 new Koa() 创建的 app实例
    // app 继承自 EventEmitter，可以触发和监听事件
    // 所以我们可以手动触发 error 事件，传入状态码 和 上下文对象
    ctx.app.emit('error', -1001, ctx)
  }
})

export default router
```



## 错误处理文件

`errorHandler.js`

```js
export default (app) => {
  // 实际开发中，可以将错误处理逻辑抽离到单独的文件中。然后再全局引入一下即可
  app.on('error', (code, ctx) => {
    let message = ''
    switch(code) {
      case -1001:
        message = '用户名或密码错误'
        break
      case -1002:
        message = '用户名不能为空'
        break
      case -1003:
        message = '密码不能为空'
        break
      default:
        message = '未知错误'
        break
    }
    ctx.body = {
      code,
      message
    }
  })
}
```

